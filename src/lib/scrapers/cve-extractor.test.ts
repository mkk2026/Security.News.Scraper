
import { describe, expect, test } from "bun:test";
import { extractAffectedSoftware } from "./cve-extractor";

describe("cve-extractor", () => {
  describe("extractAffectedSoftware", () => {
    test("returns empty array for empty input", () => {
      expect(extractAffectedSoftware("")).toEqual([]);
    });

    test("extracts single software correctly", () => {
      expect(extractAffectedSoftware("Windows 10 is affected")).toEqual(["Windows 10"]);

      const apacheResult = extractAffectedSoftware("Apache server");
      // Matches both specific "Apache" and generic "Apache server"
      expect(apacheResult).toContain("Apache");
      expect(apacheResult).toContain("Apache server");
    });

    test("extracts multiple software correctly", () => {
      const result = extractAffectedSoftware("Microsoft Office and Adobe Reader have bugs");
      expect(result).toContain("Microsoft Office");
      expect(result).toContain("Adobe Reader");
      expect(result).toHaveLength(2);
    });

    test("handles case sensitivity correctly", () => {
      const result = extractAffectedSoftware("windows 10 and UBUNTU");
      // The regex patterns preserve the original casing from the text
      expect(result).toContain("windows 10");
      expect(result).toContain("UBUNTU");
    });

    test("deduplicates matches", () => {
      const result = extractAffectedSoftware("Windows 10 and Windows 10");
      expect(result).toEqual(["Windows 10"]);
    });

    test("handles generic pattern correctly", () => {
      const result = extractAffectedSoftware("Some Unknown Enterprise software");
      expect(result).toContain("Unknown Enterprise");
    });

    test("handles mixed known and generic patterns", () => {
      const result = extractAffectedSoftware("Windows Server 2019 and Custom Platform");
      // Windows Server 2019 matches specific pattern
      expect(result).toContain("Windows Server 2019");
      // Custom Platform matches generic pattern
      expect(result).toContain("Custom Platform");
    });

    test("handles pre-filter correctly (miss case)", () => {
        // Text that doesn't contain any keywords
        expect(extractAffectedSoftware("Just some random text")).toEqual([]);
    });
  });
});
