import { describe, expect, test } from "bun:test";
import { analyzeArticleContent } from "./cve-extractor";

describe("CVE Extractor Performance", () => {
  test("Should handle large input with many CVEs efficiently", () => {
    // Generate a large string with many CVEs and no periods
    const cveCount = 5000;
    const textChunk = "Some random text without periods to force long scan ";
    let content = "";

    // Create content: "CVE-2023-0001 ... text ... CVE-2023-0002 ... text ..."
    for (let i = 0; i < cveCount; i++) {
      const id = i.toString().padStart(4, '0');
      content += `CVE-2023-${id} ${textChunk}`;
    }

    // Add a CVSS score at the very end
    content += " CVSS: 9.8";

    const result = analyzeArticleContent("Test Article", undefined, content);

    expect(result.cves.length).toBe(cveCount);
    // 5000 CVEs means 300k chars.
    // 5000 * 150k avg scan = 750M ops. Should be ~200-500ms?
    // Or maybe slower due to Regex compilation.
  });

  test("Should extract CVSS correctly from same-sentence text", () => {
    // Original code only works if no dot is between CVE and CVSS
    const title = "New Vulnerability found";
    const content = "CVE-2023-1234 has CVSS: 9.8 score. Also CVE-2023-5678 has CVSS: 7.5 score.";

    const result = analyzeArticleContent(title, undefined, content);

    const cve1 = result.cves.find(c => c.cveId === "CVE-2023-1234");
    const cve2 = result.cves.find(c => c.cveId === "CVE-2023-5678");

    expect(cve1?.cvssScore).toBe(9.8);
    expect(cve2?.cvssScore).toBe(7.5);
  });

  test("Should find CVSS even if first mention has no score", () => {
    // Regression test: multiple occurrences of same CVE
    const title = "Duplicate Mentions";
    const content = "CVE-2023-9999 is bad. But here CVE-2023-9999 has CVSS: 9.8 score.";

    const result = analyzeArticleContent(title, undefined, content);
    const cve = result.cves.find(c => c.cveId === "CVE-2023-9999");

    expect(cve).toBeDefined();
    expect(cve?.cvssScore).toBe(9.8);
  });
});
